

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>interfaces.interfaces &mdash; covgDAQ 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> covgDAQ
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfaces.html">interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../peripherals.html">peripherals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../register_index_guide.html">Register Index Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../endpoint_definitions_guide.html">Endpoint Definitions Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../new_peripheral_guide.html">New Peripheral Guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">covgDAQ</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>interfaces.interfaces</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for interfaces.interfaces</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module to configure OpalKelly XEM7310 FPGA to communicate with peripherals.</span>

<span class="sd">Use Registers for peripherals&#39; internal registers and Endpoints for Opal Kelly Endpoints on the FPGA. </span>

<span class="sd">June 2022</span>

<span class="sd">Lucas Koerner, koer2434@stthomas.edu</span>
<span class="sd">Abe Stroschein, ajstroschein@stthomas.edu</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">interfaces.utils</span> <span class="kn">import</span> <span class="n">gen_mask</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.packagename&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="s1">&#39;config.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">configs</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="c1"># TODO: make sure this path works for Windows, Mac, and Linux: https://docs.opalkelly.com/fpsdk/frontpanel-api/programming-languages/</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;frontpanel_path&#39;</span><span class="p">],</span> <span class="s1">&#39;API/Python/3.7/x64&#39;</span><span class="p">))</span> <span class="c1"># Add path to ok.py to PATH for import</span>
<span class="n">os</span><span class="o">.</span><span class="n">add_dll_directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;frontpanel_path&#39;</span><span class="p">],</span> <span class="s1">&#39;API/lib/x64&#39;</span><span class="p">))</span>   <span class="c1"># Make DLL (okFrontPanel.dll) available</span>
<span class="kn">import</span> <span class="nn">ok</span>

<div class="viewcode-block" id="Register"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Register">[docs]</a><span class="k">class</span> <span class="nc">Register</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for internal registers on a device.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    address : int</span>
<span class="sd">        Address location of the register.</span>
<span class="sd">    default : int</span>
<span class="sd">        Default value of the register.</span>
<span class="sd">    bit_index_high : int</span>
<span class="sd">        Index of the MSB in the register.</span>
<span class="sd">    bit_index_low : int</span>
<span class="sd">        Index of the LSB in the register.</span>
<span class="sd">    bit_width : int</span>
<span class="sd">        Width of the register in bits.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">bit_index_high</span><span class="p">,</span> <span class="n">bit_index_low</span><span class="p">,</span> <span class="n">bit_width</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">=</span> <span class="n">bit_index_high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">=</span> <span class="n">bit_index_low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bit_width</span> <span class="o">=</span> <span class="n">bit_width</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_index_low</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_index_high</span><span class="si">}</span><span class="s1">]&#39;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Register.get_chip_registers"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Register.get_chip_registers">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_chip_registers</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">workbook_path</span><span class="o">=</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;registers_path&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary of Registers from a page in an Excel spreadsheet.&quot;&quot;&quot;</span>
        
        <span class="n">reg_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sheet_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">workbook_path</span><span class="p">,</span> <span class="n">sheet</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sheet_data</span><span class="p">)):</span>
            <span class="n">row_data</span> <span class="o">=</span> <span class="n">sheet_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="n">reg_dict</span><span class="p">[</span><span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Register</span><span class="p">(</span>
                <span class="n">address</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Hex Address&#39;</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="n">default</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Default Value&#39;</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="n">bit_width</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Bit Width&#39;</span><span class="p">]),</span>
                <span class="n">bit_index_high</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Bit Index (High)&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Bit Index (High)&#39;</span><span class="p">])),</span>  <span class="c1"># Bit Index of None means the register takes up the whole endpoint</span>
                <span class="n">bit_index_low</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Bit Index (Low)&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;Bit Index (Low)&#39;</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">reg_dict</span></div></div>


<div class="viewcode-block" id="Endpoint"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Endpoint">[docs]</a><span class="k">class</span> <span class="nc">Endpoint</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for Opal Kelly endpoints on the FPGA.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    endpoints_from_defines : dict</span>
<span class="sd">        Class attribute. Dictionary of each group of endpoints paired with inner dictionaries</span>
<span class="sd">        of endpoint names to Endpoint objects, starts empty.</span>
<span class="sd">    I2CDAQ_level_shifted : dict</span>
<span class="sd">        Class attribute. Dictionary of Endpoints for the level shifted I2CDAQ bus.</span>
<span class="sd">    I2CDAQ_QW : dict</span>
<span class="sd">        Class attribute. Dictionary of Endpoints for QW 3.3V I2CDAQ bus.</span>
<span class="sd">    address : int</span>
<span class="sd">        Address location of the Endpoint.</span>
<span class="sd">    bit_index_low : int</span>
<span class="sd">        Index of the LSB of the Endpoint.</span>
<span class="sd">    bit_index_high : int</span>
<span class="sd">        Index of the MSB of the Endpoint.</span>
<span class="sd">    bit_width : int</span>
<span class="sd">        Width of the Endpoint in bits.</span>
<span class="sd">    gen_bit : bool</span>
<span class="sd">        Whether to increment the bits when incrementing the endpoint.</span>
<span class="sd">    gen_address : bool</span>
<span class="sd">        Whether to increment the address when incrementing the endpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s1">&#39;endpoint_max_width&#39;</span><span class="p">]</span>  <span class="c1"># Maximum bit width of an Endpoint. Used to wrap Endpoints to the next address when incrementing</span>
    <span class="n">endpoints_from_defines</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">I2CDAQ_level_shifted</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">I2CDAQ_QW</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">bit_index_low</span><span class="p">,</span> <span class="n">bit_width</span><span class="p">,</span> <span class="n">gen_bit</span><span class="p">,</span> <span class="n">gen_address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">=</span> <span class="n">bit_index_low</span>
        <span class="c1"># Endpoints that are only containing addresses will be generated from ep_defines.v with bit_index_low = None</span>
        <span class="k">if</span> <span class="n">bit_index_low</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">=</span> <span class="n">bit_index_low</span> <span class="o">+</span> <span class="n">bit_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bit_width</span> <span class="o">=</span> <span class="n">bit_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_bit</span> <span class="o">=</span> <span class="n">gen_bit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_address</span> <span class="o">=</span> <span class="n">gen_address</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">str_rep</span> <span class="o">=</span> <span class="s1">&#39;0x</span><span class="si">{:0x}</span><span class="s1">[</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_index_high</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">str_rep</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Endpoint.update_endpoints_from_defines"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Endpoint.update_endpoints_from_defines">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_endpoints_from_defines</span><span class="p">(</span><span class="n">ep_defines_path</span><span class="o">=</span><span class="n">configs</span><span class="p">[</span><span class="s1">&#39;ep_defines_path&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Store and return a dictionary of Endpoints for each chip in ep_defines.v.</span>

<span class="sd">        Returns -1 if there is a naming collision in ep_defines.v</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get all lines</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ep_defines_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># Get all the endpoints from the lines</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="c1"># Check if the line defines an endpoint</span>
            <span class="n">pieces</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="c1"># Ex. line = &quot;`define AD7961_PIPE_OUT_GEN_ADDR 8&#39;hA1 // address=TEST_ADDRESS bit_width=32&quot;</span>
            <span class="c1">#   pieces = [&quot;`define&quot;, &quot;AD7961_PIPE_OUT_GEN_ADDR&quot;, &quot;8&#39;hA1&quot;, &quot;//&quot;, &quot;address=TEST_ADDRESS&quot;, &quot;bit_width=32&quot;]</span>
            <span class="k">if</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;`define&#39;</span><span class="p">:</span>
                <span class="c1"># Line does not define an endpoint, skip</span>
                <span class="k">continue</span>

            <span class="c1"># Extract data from definition</span>
            <span class="c1"># Class name</span>
            <span class="n">class_name_end</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">class_name_end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># .find() returns -1 if not found, without an underscore we cannot</span>
                <span class="c1"># tell where the class and endpoint names are separated</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAIL: no endpoint name found&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="n">class_name_end</span><span class="p">]</span>

            <span class="c1"># Whether to generate bits</span>
            <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">class_name_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">previous_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">)</span>
            <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">remaining_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_GEN_BIT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># If the remaining name is shorter it is because GEN_BIT was replaced</span>
            <span class="n">gen_bit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">previous_len</span>

            <span class="c1"># Whether to generate address</span>
            <span class="n">previous_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">)</span>
            <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">remaining_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_GEN_ADDR&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># If the remaining name is shorter it is because GEN_ADDR was replaced</span>
            <span class="n">gen_address</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">previous_len</span>

            <span class="c1"># Endpoint name</span>
            <span class="n">ep_name</span> <span class="o">=</span> <span class="n">remaining_name</span>
            <span class="k">if</span> <span class="n">ep_name</span> <span class="o">==</span> <span class="s1">&#39;NUM_OUTGOING_EPS&#39;</span><span class="p">:</span>
                <span class="c1"># This is not an endpoint and does not match the</span>
                <span class="c1"># format of the others so we skip it</span>
                <span class="k">continue</span>

            <span class="c1"># Address, bit, and bit_width</span>
            <span class="k">if</span> <span class="s2">&quot;8&#39;h&quot;</span> <span class="ow">in</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="c1"># Definition holds an address, take that value</span>
                <span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">:],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">bit_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Definition holds a bit, take address from comment</span>
                <span class="n">comment_address</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;0x&#39;</span> <span class="ow">in</span> <span class="n">comment_address</span><span class="p">:</span>
                    <span class="c1"># Address comment has a hex value</span>
                    <span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">comment_address</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Address comment has the name of another endpoint so store</span>
                    <span class="c1"># the interfaces.py name of that endpoint so we can look it</span>
                    <span class="c1"># up going through all lines</span>
                    <span class="n">address_name</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">address_name_no_gen</span> <span class="o">=</span> <span class="n">address_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s1">&#39;_GEN&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">address</span> <span class="o">=</span> <span class="n">address_name_no_gen</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">bit_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">Endpoint</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">bit_index_low</span><span class="o">=</span><span class="n">bit</span><span class="p">,</span> <span class="n">bit_width</span><span class="o">=</span><span class="n">bit_width</span><span class="p">,</span> <span class="n">gen_bit</span><span class="o">=</span><span class="n">gen_bit</span><span class="p">,</span> <span class="n">gen_address</span><span class="o">=</span><span class="n">gen_address</span><span class="p">)</span>

            <span class="c1"># Put defined endpoint in endpoints_from_defines dictionary</span>
            <span class="k">if</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Class doesn&#39;t exist yet in the dictionary</span>
                <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">ep_name</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Class already exists in the dictionary</span>
                <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="p">[</span><span class="n">class_name</span><span class="p">][</span><span class="n">ep_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span>

        <span class="c1"># Go through endpoints_from_defines and find hex addresses for those with endpoint</span>
        <span class="c1"># name references instead</span>
        <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">endpoint_name</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">endpoint_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">endpoint</span><span class="o">.</span><span class="n">address</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="c1"># Address is a name</span>
                    <span class="n">class_name</span><span class="p">,</span> <span class="n">ep_name</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">referenced_group</span> <span class="o">=</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">class_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">referenced_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="n">endpoint_name</span><span class="si">}</span><span class="s1">]: Referenced group &quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s1">&quot; not found.&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">referenced_endpoint</span> <span class="o">=</span> <span class="n">referenced_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ep_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">referenced_endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s1">[</span><span class="si">{</span><span class="n">endpoint_name</span><span class="si">}</span><span class="s1">]: Referenced endpoint &quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">ep_name</span><span class="si">}</span><span class="s1">&quot; not found.&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">endpoint</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">referenced_endpoint</span><span class="o">.</span><span class="n">address</span>

        <span class="c1"># At this point the dictionary should be built</span>
        <span class="c1"># Check for naming collisions (2+ names sharing same address or bit within address)</span>
        <span class="c1"># Collect all top level endpoints</span>
        <span class="n">top_level_eps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">Endpoint</span><span class="p">]</span>
        <span class="c1"># Collect all endpoints in dictionaries</span>
        <span class="n">lower_level_eps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">eps</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">]:</span>
            <span class="n">lower_level_eps</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">none_to_neg_1</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="c1"># Make tuples of (address, bit) from each list, then concatenate the lists</span>
        <span class="c1"># The none_to_neg_1.get() translates None values of bit_index_low to -1 for sorting later</span>
        <span class="n">list_eps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ep</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">none_to_neg_1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">,</span> <span class="n">ep</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">))</span> <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">top_level_eps</span><span class="p">]</span>
        <span class="n">list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_eps</span><span class="p">)</span>
        <span class="n">set_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_eps</span><span class="p">))</span>  <span class="c1"># A set removes duplicates</span>

        <span class="k">if</span> <span class="n">list_len</span> <span class="o">!=</span> <span class="n">set_len</span><span class="p">:</span>
            <span class="c1"># There may be duplicates. May not, because different groups can have endpoints of the same name.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for naming collisions in ep_defines.v ...&#39;</span><span class="p">)</span>

            <span class="c1"># Search through to find duplicates</span>
            <span class="c1"># Copy the list to keep order in the original</span>
            <span class="n">sorted_list_eps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">list_eps</span><span class="p">)</span>
            <span class="n">sorted_list_eps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Put duplicates next to one another in new list</span>
            <span class="n">top_level_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span>
                <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">==</span> <span class="n">Endpoint</span><span class="p">]</span>
            <span class="n">lower_level_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_dicts</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">]:</span>
                <span class="n">lower_level_names</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sub_dicts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">list_names</span> <span class="o">=</span> <span class="n">top_level_names</span> <span class="o">+</span> <span class="n">lower_level_names</span>

            <span class="n">collision</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Keep track of whether there was a collision for return value</span>
            <span class="k">for</span> <span class="n">ep_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_list_eps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ep</span> <span class="o">=</span> <span class="n">sorted_list_eps</span><span class="p">[</span><span class="n">ep_index</span><span class="p">]</span>
                <span class="n">next_ep</span> <span class="o">=</span> <span class="n">sorted_list_eps</span><span class="p">[</span><span class="n">ep_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">list_names</span><span class="p">[</span><span class="n">list_eps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sorted_list_eps</span><span class="p">[</span><span class="n">ep_index</span><span class="p">])]</span>
                <span class="n">next_name</span> <span class="o">=</span> <span class="n">list_names</span><span class="p">[</span><span class="n">list_eps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">sorted_list_eps</span><span class="p">[</span><span class="n">ep_index</span><span class="p">])]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">next_ep</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="n">next_name</span><span class="p">):</span>
                    <span class="c1"># Need different names because otherwise they are from different groups and do not actually conflict</span>

                    <span class="c1"># The name part of this uses a list of names created in the same order as the original list_eps (list_names)</span>
                    <span class="c1"># then finds the index of the current endpoint in list_eps and uses that to find the corresponding</span>
                    <span class="c1"># name in list_names</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Collision found at address=</span><span class="si">{</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> bit=</span><span class="si">{</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">next_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">collision</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">collision</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No collisions found.&#39;</span><span class="p">)</span>

        <span class="c1"># If the list and set match length, no duplicates</span>
        <span class="k">return</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span></div>

<div class="viewcode-block" id="Endpoint.get_chip_endpoints"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Endpoint.get_chip_endpoints">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_chip_endpoints</span><span class="p">(</span><span class="n">chip_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of the dictionary of Endpoints for a specific chip or group.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">():</span>
            <span class="n">Endpoint</span><span class="o">.</span><span class="n">update_endpoints_from_defines</span><span class="p">()</span>

        <span class="c1"># copy.deepcopy() is important here because it makes a copy of the</span>
        <span class="c1"># dictionary so that when we increment it for multiple instantiations</span>
        <span class="c1"># of the chip, each previously instantiated chip will not have its</span>
        <span class="c1"># endpoints affected by the increment, only future instantiations.</span>
        <span class="c1"># Using deepcopy() ensures that any dictionaries inside the dictionary</span>
        <span class="c1"># we copy also get copied, not left as references.</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Endpoint</span><span class="o">.</span><span class="n">endpoints_from_defines</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chip_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="Endpoint.excel_to_defines"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Endpoint.excel_to_defines">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">excel_to_defines</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">defines_path</span><span class="p">,</span> <span class="n">sheet</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an Excel spreadsheet of endpoint definitions to Verilog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        excel_path : str</span>
<span class="sd">            The path to the Excel spreadsheet to convert.</span>
<span class="sd">        defines_path : str</span>
<span class="sd">            The path to the Verilog file to create.</span>
<span class="sd">        sheet : int or str</span>
<span class="sd">            Optional. The int index of the sheet to read from the Excel</span>
<span class="sd">            spreadsheet, or the str sheet name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str : the text written to the Verilog file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sheet_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">sheet</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sheet_data</span><span class="p">[</span><span class="s1">&#39;Generated Line&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">defines_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span></div>

<div class="viewcode-block" id="Endpoint.advance_endpoints"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.Endpoint.advance_endpoints">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">advance_endpoints</span><span class="p">(</span><span class="n">endpoints_dict</span><span class="p">,</span> <span class="n">advance_num</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Advances Endpoints in a dict in place by advance_num. Checks each</span>
<span class="sd">        Endpoint&#39;s gen_bit and gen_address attributes to see whether to</span>
<span class="sd">        increment the bit or the address or both.</span>

<span class="sd">        Example usage:</span>
<span class="sd">            endpoints=Endpoint.advance_endpoints(Endpoint.get_chip_endpoints(&#39;I2CDAQ&#39;),1)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        endpoints_dict : dict of Endpoints</span>
<span class="sd">            The dict of Endpoints to advance by advance_num.</span>
<span class="sd">        advance_num : int</span>
<span class="sd">            How much to advance the Endpoints by.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict : the same dict of Endpoints given in endpoints_dict, now advanced</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">endpoints_dict</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoints_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">gen_bit</span><span class="p">:</span>
                <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">+=</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">.</span><span class="n">bit_width</span> <span class="o">*</span> <span class="n">advance_num</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">&gt;</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">MAX_WIDTH</span><span class="p">:</span>
                    <span class="c1"># Endpoint does not fit, wrap to next address</span>
                    <span class="n">endpoint</span><span class="o">.</span><span class="n">address</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">%=</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">MAX_WIDTH</span>
                <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">+</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_width</span>
                <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">&gt;</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">MAX_WIDTH</span><span class="p">:</span>
                    <span class="c1"># Endpoint split across two addresses -&gt; move to next address, start at bit 0</span>
                    <span class="n">endpoint</span><span class="o">.</span><span class="n">address</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_index_low</span> <span class="o">+</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">bit_width</span>
            <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">gen_address</span><span class="p">:</span>
                <span class="n">endpoint</span><span class="o">.</span><span class="n">address</span> <span class="o">+=</span> <span class="n">advance_num</span>
        <span class="k">return</span> <span class="n">endpoints_dict</span></div></div>

<span class="c1"># Class for the FPGA itself. Handles FPGA configuration, setting wire values,</span>
<span class="c1"># and other FPGA specific functions.</span>


<div class="viewcode-block" id="FPGA"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA">[docs]</a><span class="k">class</span> <span class="nc">FPGA</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for the Opal Kelly FPGA itself.</span>
<span class="sd">    Derived from OpalKelly Python examples.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    bitfile : str</span>
<span class="sd">        Path to the bitfile to load on the FPGA.</span>
<span class="sd">    xem : ok.okCFrontPanel</span>
<span class="sd">        Opal Kelly API connection to the FPGA.</span>
<span class="sd">    device_info : ok.okTDeviceInfo</span>
<span class="sd">        General information about the FPGA.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bitfile</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bitfile</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="c1"># Use bitfile from config.yaml fpga_bitfile_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bitfile</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="s1">&#39;fpga_bitfile_path&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bitfile</span> <span class="o">=</span> <span class="n">bitfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="k">return</span>

<div class="viewcode-block" id="FPGA.init_device"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.init_device">[docs]</a>    <span class="k">def</span> <span class="nf">init_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the FPGA for use and print device information.</span>

<span class="sd">        Connect to the FPGA and load the bitfile. Return False on any errors.</span>
<span class="sd">        Only run this once or the FPGA connection will fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Open the first device we find.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span> <span class="o">=</span> <span class="n">ok</span><span class="o">.</span><span class="n">okCFrontPanel</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">NoError</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">OpenBySerial</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A device could not be opened.  Is one connected?&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Get some general information about the device.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_info</span> <span class="o">=</span> <span class="n">ok</span><span class="o">.</span><span class="n">okTDeviceInfo</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">NoError</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">GetDeviceInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to retrieve device information.&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         Product: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="o">.</span><span class="n">productName</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Firmware version: </span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="o">.</span><span class="n">deviceMajorVersion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="o">.</span><span class="n">deviceMinorVersion</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Serial Number: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="o">.</span><span class="n">serialNumber</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;       Device ID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="o">.</span><span class="n">deviceID</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;       USB Speed  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info</span><span class="o">.</span><span class="n">usbSpeed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">LoadDefaultPLLConfiguration</span><span class="p">()</span>

        <span class="c1"># Download the configuration file.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">NoError</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">ConfigureFPGA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitfile</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FPGA configuration failed.&quot;</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded bit-file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitfile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipped bit-file update&#39;</span><span class="p">)</span>

        <span class="c1"># Check for FrontPanel support in the FPGA configuration.</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">False</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">IsFrontPanelEnabled</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FrontPanel support is not available.&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FrontPanel support is available.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FPGA.read_pipe_out"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.read_pipe_out">[docs]</a>    <span class="k">def</span> <span class="nf">read_pipe_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the filled buffer and error code after reading an OK PipeOut.</span>
<span class="sd">            data_len is length in bytes (must be multiple of 16)</span>
<span class="sd">            returns: bytearray; error code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">data_len</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">ReadFromPipeOut</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
        <span class="c1"># print(&#39;read_pipe_out:&#39;, addr, buf)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error code </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">buf</span><span class="p">,</span> <span class="n">e</span></div>

<div class="viewcode-block" id="FPGA.set_wire"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.set_wire">[docs]</a>    <span class="k">def</span> <span class="nf">set_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="mh">0xFFFFFFFF</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the error code after setting an OK WireIn value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;set_wire(address=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">, value=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">, mask=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">error_code</span></div>

<div class="viewcode-block" id="FPGA.read_wire"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.read_wire">[docs]</a>    <span class="k">def</span> <span class="nf">read_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the read data after reading an OK WireOut.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireOuts</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">GetWireOutValue</span><span class="p">(</span><span class="n">address</span><span class="p">)</span></div>

<div class="viewcode-block" id="FPGA.set_endpoint"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.set_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">set_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set all bits in an Endpoint high.&quot;&quot;&quot;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">gen_mask</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">,</span> <span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;set_endpoint(address=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">, value=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s1">, mask=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span></div>

<div class="viewcode-block" id="FPGA.clear_endpoint"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.clear_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">clear_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set all bits in an Endpoint low.&quot;&quot;&quot;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">gen_mask</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">,</span> <span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;clear_endpoint(address=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">, value=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">, mask=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># clear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span></div>

<div class="viewcode-block" id="FPGA.toggle_low"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.toggle_low">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_low</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Toggle all bits in an Endpoint low then back to high.&quot;&quot;&quot;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">gen_mask</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">,</span> <span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span>
            <span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># toggle low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>   <span class="c1"># back high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span></div>

<div class="viewcode-block" id="FPGA.toggle_high"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.toggle_high">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_high</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Toggle all bits in an Endpoint high then back to low.&quot;&quot;&quot;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">gen_mask</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">,</span> <span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># toggle high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">SetWireInValue</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>   <span class="c1"># back low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireIns</span><span class="p">()</span></div>

<div class="viewcode-block" id="FPGA.send_trig"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.send_trig">[docs]</a>    <span class="k">def</span> <span class="nf">send_trig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the error code after activating an OK TriggerIn Endpoint.</span>

<span class="sd">        Expects a single bit, not yet implement for multiple bits and will only</span>
<span class="sd">        activate the LSB if the Endpoint containts multiple bits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&#39;send_trig(address={hex(ep_bit.address)},bit={ep_bit.bit_index_low})&#39;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">ActivateTriggerIn</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">)</span></div>

<div class="viewcode-block" id="FPGA.read_trig"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.read_trig">[docs]</a>    <span class="k">def</span> <span class="nf">read_trig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read an OK TriggerOut Endpoint.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ep_bit : Endpoint</span>
<span class="sd">            The endpoint containing the bit_index_low and address of the</span>
<span class="sd">            TriggerOut to read.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether the TriggerOut has been triggered.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateTriggerOuts</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">IsTriggered</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ep_bit</span><span class="o">.</span><span class="n">bit_index_low</span><span class="p">))</span></div>

<div class="viewcode-block" id="FPGA.read_ep"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.read_ep">[docs]</a>    <span class="k">def</span> <span class="nf">read_ep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ep_bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the error code after reading an OK WireOut Endpoint.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">UpdateWireOuts</span><span class="p">()</span>
        <span class="n">read_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xem</span><span class="o">.</span><span class="n">GetWireOutValue</span><span class="p">(</span><span class="n">ep_bit</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">read_out</span></div>

<div class="viewcode-block" id="FPGA.set_wire_bit"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.set_wire_bit">[docs]</a>    <span class="k">def</span> <span class="nf">set_wire_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a single bit to 1 in a OpalKelly wire in.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;set_wire_bit(address=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">,value=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span><span class="si">}</span><span class="s1">,mask=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_wire</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span></div>

<div class="viewcode-block" id="FPGA.clear_wire_bit"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.clear_wire_bit">[docs]</a>    <span class="k">def</span> <span class="nf">clear_wire_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear a single bit to 0 in a OpalKelly wire in.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;clear_wire_bit(address=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">,value=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span><span class="si">}</span><span class="s1">,mask=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_wire</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span></div>

<div class="viewcode-block" id="FPGA.set_ep_simultaneous"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.set_ep_simultaneous">[docs]</a>    <span class="k">def</span> <span class="nf">set_ep_simultaneous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">bit_list</span><span class="p">,</span> <span class="n">val_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; set multiple values to the wire of a single endpoint&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">bit</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bit_list</span><span class="p">,</span> <span class="n">val_list</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simultaneous wire write (address=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s1">,value=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">,mask=</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_wire</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPGA.read_wire_bit"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.FPGA.read_wire_bit">[docs]</a>    <span class="k">def</span> <span class="nf">read_wire_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">bit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a single bit in a OpalKelly wire in.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_wire</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span></div></div>


<span class="c1"># TODO: should there be a &#39;device&#39; or similar class that all controllers are subclasses of?</span>
<div class="viewcode-block" id="disp_device"><a class="viewcode-back" href="../../interfaces.html#interfaces.interfaces.disp_device">[docs]</a><span class="k">def</span> <span class="nf">disp_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display endpoints and registers for a chip.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dev : I2CController or SPIController or SPIFifoDriven or AD7961</span>
<span class="sd">        Chip instance to display information for.</span>
<span class="sd">    reg : bool</span>
<span class="sd">        Whether to display registers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Displaying endpoints&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dev</span><span class="o">.</span><span class="n">endpoints</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">endpoints</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Displaying registers&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dev</span><span class="o">.</span><span class="n">registers</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, University of St. Thomas CpE/EE Instrumentation Group.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>